<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Romanf888 Adventure V15</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

        body { margin: 0; padding: 0; background-color: #050505; overflow: hidden; font-family: 'Rajdhani', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }

        /* UI G√âN√âRIQUE */
        .menu-btn {
            background: linear-gradient(135deg, #00eaff, #0077ff); border: none; color: white;
            padding: 12px 30px; font-size: 18px; font-weight: bold; border-radius: 5px; margin: 8px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 0 10px #00eaff; min-width: 200px; pointer-events: auto; display: block;
        }
        .menu-btn:active { transform: scale(0.95); }
        .menu-btn.secondary { background: rgba(255,255,255,0.1); border: 1px solid #555; box-shadow: none; }
        
        /* SLOT BUTTONS */
        .slot-btn {
            background: #222; border: 1px solid #00eaff; color: white;
            padding: 15px; margin: 10px; width: 80%; max-width: 400px;
            text-align: left; cursor: pointer; pointer-events: auto;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 8px; transition: background 0.2s;
        }
        .slot-btn:active { background: #333; }
        .slot-info { font-size: 14px; color: #aaa; }
        .slot-title { font-size: 20px; font-weight: bold; color: #00eaff; }

        /* EFFET HARDCORE */
        .btn-hardcore {
            border-left: 5px solid #ff0000 !important;
            animation: shake 0.5s infinite;
            background: linear-gradient(135deg, #500, #900) !important;
            box-shadow: 0 0 15px #f00 !important;
        }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }

        /* √âCRANS (Menus) - Z-Index 100 */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 20, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; z-index: 100; transition: opacity 0.3s; }
        .hidden { display: none !important; }

        /* HUD JEU - Z-Index 50 */
        #game-hud { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none; }
        
        .top-bar { 
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: flex-start;
            color: white; font-size: 20px; font-weight: bold; 
            text-shadow: 1px 1px 0 #000; pointer-events: none; box-sizing: border-box;
        }
        #timer-display { color: #fff; font-size: 24px; margin-top: 5px; }
        #timer-display.danger { color: #ff0000; animation: pulseRed 0.5s infinite; }
        @keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* BOUTON PAUSE FIX√â */
        .pause-container { pointer-events: auto; display: flex; align-items: center; }
        #pause-btn { 
            cursor: pointer; font-size: 24px; 
            background: rgba(0,0,0,0.6); width: 50px; height: 50px; 
            display: flex; justify-content: center; align-items: center; 
            border-radius: 50%; border: 2px solid #fff; margin-left: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #pause-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* MENU PAUSE & TABS */
        #pause-menu-content { width: 95%; max-width: 500px; background: #111; border: 2px solid #00eaff; border-radius: 10px; padding: 15px; box-sizing: border-box; }
        .tab-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; overflow-x: auto; }
        .tab-btn { background: none; border: none; color: #777; font-size: 12px; font-weight: bold; padding: 8px 5px; cursor: pointer; pointer-events: auto; flex: 1; min-width: 50px; }
        .tab-btn.active { color: #00eaff; border-bottom: 2px solid #00eaff; background: rgba(0, 234, 255, 0.1); }
        .tab-content { display: none; color: white; text-align: left; max-height: 60vh; overflow-y: auto; width: 100%; }
        .tab-content.active { display: block; }

        /* CHEAT INPUT */
        .cheat-input {
            width: 70%; padding: 10px; border-radius: 5px; border: 1px solid #555; 
            background: #222; color: white; font-family: 'Rajdhani', sans-serif; 
            text-transform: uppercase; font-size: 18px; text-align: center; pointer-events: auto;
        }

        /* PARAM√àTRES */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .setting-label { font-size: 16px; color: #ccc; }
        .toggle-btn { background: #333; border: 1px solid #555; color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; pointer-events: auto; font-size: 14px; }
        .toggle-btn.on { background: #00eaff; color: black; border-color: #00eaff; }

        /* CONTROLS */
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; pointer-events: auto; box-sizing: border-box; }
        .btn { width: 75px; height: 75px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 30px; }
        .btn.active { background: rgba(0, 234, 255, 0.4); border-color: #00eaff; }
        #btn-dash { color: #00eaff; border-color: #00eaff; border-radius: 15px; width: 60px; height: 60px; margin-bottom: 10px; }
        #dash-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(0, 234, 255, 0.3); transition: height 0.1s linear; }

        /* NOTIFS & SUCC√àS */
        #success-popup { position: absolute; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0, 30, 60, 0.95); border: 1px solid #ffd700; color: white; padding: 10px 30px; border-radius: 20px; transition: top 0.5s; z-index: 200; text-align: center; width: 80%; box-sizing: border-box;}
        .achievement { background: #222; border: 1px solid #444; border-radius: 5px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        .achievement.unlocked { border-color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .ach-icon { font-size: 24px; opacity: 0.3; }
        .achievement.unlocked .ach-icon { opacity: 1; }
        
        /* GAME OVER / WIN */
        .screen h1 { font-size: 40px; color: white; text-transform: uppercase; text-shadow: 0 0 10px #f00; text-align: center; }
        #fps-counter { position: absolute; bottom: 5px; right: 5px; color: lime; font-size: 10px; font-family: monospace; display: none; }
        
        /* RAINBOW INVINCIBLE */
        #invincible-timer { 
            display: none; margin-top: 5px;
            color: #fff; font-weight: bold; font-size: 18px; text-shadow: 0 0 5px #fff;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <!-- MENU PRINCIPAL -->
        <div id="main-menu" class="screen">
            <h1 style="color:white; text-shadow: 0 0 20px #00eaff; font-size:50px; margin-bottom:0;">NEON<br>ODYSSEY</h1>
            <div style="color:#00eaff; letter-spacing:3px; margin-bottom:30px;">BY ROMANF888</div>
            <button class="menu-btn" onclick="showSlotMenu()">JOUER</button>
            <button class="menu-btn secondary" onclick="openAchievementsInMenu()">SUCC√àS</button>
            <div style="color:#555; position:absolute; bottom:10px;">v15.0 Final Clean</div>
        </div>

        <!-- S√âLECTION SLOT -->
        <div id="slot-menu" class="screen hidden">
            <h2 style="color:white; margin-bottom:20px;">CHOISIR SAUVEGARDE</h2>
            <div id="slots-container" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                <!-- G√©n√©r√© par JS -->
            </div>
            <button class="menu-btn secondary" onclick="showScreen('main-menu')">RETOUR</button>
        </div>

        <!-- S√âLECTION DIFFICULT√â -->
        <div id="difficulty-menu" class="screen hidden">
            <h2 style="color:white; margin-bottom:30px;">MODE DE JEU</h2>
            <button class="menu-btn" style="border-left:5px solid #0f0" onclick="startGame('EASY')">FACILE</button>
            <button class="menu-btn" style="border-left:5px solid #fa0" onclick="startGame('TIMED')">CHRONO (60s)</button>
            <button class="menu-btn btn-hardcore" onclick="startGame('HARDCORE')">HARDCORE (60s)</button>
            <div style="color:#aaa; font-size:12px; margin-top:20px; max-width:300px; text-align:center;">
                ‚ö†Ô∏è NOTE: La sauvegarde est d√©sactiv√©e en modes Chrono et Hardcore.
            </div>
            <button class="menu-btn secondary" onclick="showSlotMenu()">RETOUR</button>
        </div>

        <!-- HUD JEU -->
        <div id="game-hud">
            <div class="top-bar">
                <div style="display:flex; flex-direction:column;">
                    <span>NIV <span id="ui-level">1</span></span>
                    <span id="ui-biome-name" style="font-size:12px; color:#aaa;">NEON CITY</span>
                    <div id="invincible-timer">INVINCIBLE: 10s</div>
                </div>
                <div id="timer-display">--:--</div>
                <div class="pause-container">
                    <span style="margin-right:10px;">‚ô¶ <span id="ui-coins">0</span></span>
                    <div id="pause-btn" onclick="togglePause()">‚öôÔ∏è</div>
                </div>
            </div>
            
            <div class="controls">
                <div style="display:flex; gap:20px; align-items:flex-end;">
                    <div class="btn" id="btn-left">‚óÄ</div>
                    <div class="btn" id="btn-right">‚ñ∂</div>
                </div>
                <div style="display:flex; gap:20px; align-items:flex-end;">
                    <div class="btn" id="btn-dash">‚ö°<div id="dash-overlay"></div></div>
                    <div class="btn" id="btn-jump">‚ñ≤</div>
                </div>
            </div>
            <div id="fps-counter">60 FPS</div>
        </div>

        <!-- MENU PAUSE COMPLET -->
        <div id="pause-menu" class="screen hidden" style="background:rgba(0,0,0,0.8);">
            <div id="pause-menu-content">
                <div class="tab-header">
                    <button class="tab-btn active" id="btn-tab-main" onclick="switchTab('tab-main')">JEU</button>
                    <button class="tab-btn" id="btn-tab-settings" onclick="switchTab('tab-settings')">OPTS</button>
                    <button class="tab-btn" id="btn-tab-codes" onclick="switchTab('tab-codes')">CODES</button>
                    <button class="tab-btn" id="btn-tab-achievements" onclick="switchTab('tab-achievements')">SUCC√àS</button>
                    <button class="tab-btn" id="btn-tab-save" onclick="switchTab('tab-save')">DATA</button>
                </div>

                <!-- Onglet JEU -->
                <div id="tab-main" class="tab-content active" style="text-align:center;">
                    <h2 style="margin-top:0; color:#00eaff;">PAUSE</h2>
                    <button class="menu-btn" onclick="togglePause()">REPRENDRE</button>
                    <button class="menu-btn secondary" onclick="exitToMenu()">QUITTER</button>
                </div>

                <!-- Onglet CODES -->
                <div id="tab-codes" class="tab-content" style="text-align:center;">
                    <h3 style="color:#aaa;">CODES DE TRICHE</h3>
                    <input type="text" id="cheat-input" class="cheat-input" placeholder="ENTRER CODE">
                    <button class="menu-btn" style="padding:10px 20px; margin-top:10px;" onclick="checkCheat()">ACTIVER</button>
                    <p id="cheat-status" style="color:#666; font-size:12px; margin-top:20px;">Utilisation unique par sauvegarde.</p>
                </div>

                <!-- Onglet PARAM√àTRES -->
                <div id="tab-settings" class="tab-content">
                    <div class="setting-row">
                        <span class="setting-label">Son</span>
                        <button class="toggle-btn on" id="opt-sound" onclick="toggleOption('sound')">ON</button>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Graphismes</span>
                        <button class="toggle-btn on" id="opt-gfx" onclick="toggleOption('gfx')">HIGH</button>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Afficher FPS</span>
                        <button class="toggle-btn" id="opt-fps" onclick="toggleOption('fps')">OFF</button>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">R√©solution</span>
                        <button class="toggle-btn on" id="opt-res" onclick="toggleOption('res')">100%</button>
                    </div>
                </div>

                <!-- Onglet SUCC√àS -->
                <div id="tab-achievements" class="tab-content"></div>

                <!-- Onglet SAUVEGARDE -->
                <div id="tab-save" class="tab-content" style="text-align:center;">
                    <div id="save-controls">
                        <p style="color:#888; font-size:14px;">Sauvegarder manuellement sur le Slot actuel.</p>
                        <button class="menu-btn" onclick="saveProgress(true)">SAUVEGARDER</button>
                        <button class="menu-btn secondary" style="border-color:red; color:#ff8888;" onclick="resetProgress()">EFFACER SLOT</button>
                    </div>
                    <div id="save-disabled" style="display:none; color:red; font-weight:bold; margin-top:50px;">
                        NON DISPONIBLE<br>EN CE MODE
                    </div>
                </div>
            </div>
        </div>

        <!-- POPUP SUCC√àS -->
        <div id="success-popup">
            <h3 style="margin:0; color:#ffd700">SUCC√àS</h3>
            <span id="success-desc">Description</span>
        </div>

        <!-- GAME OVER -->
        <div id="game-over-screen" class="screen hidden">
            <h1 style="color:red; text-shadow:0 0 20px red;">GAME OVER</h1>
            <p id="death-reason" style="color:#aaa; margin-bottom:20px;">Temps √©coul√© !</p>
            <button class="menu-btn" onclick="retryGame()">R√âESSAYER</button>
            <button class="menu-btn secondary" onclick="exitToMenu()">MENU</button>
        </div>

        <!-- FIN DE NIVEAU -->
        <div id="level-end-screen" class="screen hidden">
            <h1 style="color:#00eaff;">NIVEAU TERMIN√â</h1>
            <button class="menu-btn" onclick="nextLevel()">CONTINUER</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- CONFIGURATION ---
        let OPTIONS = { sound: true, gfx: 'HIGH', fps: false, res: 1.0 };
        const BIOMES = [
            { name: "NEON CITY", bg: ['#020024', '#090979'], plat: '#00eaff', enemy: '#ff0055' },
            { name: "MAGMA CORE", bg: ['#1a0000', '#4a0000'], plat: '#ff4d4d', enemy: '#ffaa00' },
            { name: "TOXIC SEWER", bg: ['#001a00', '#003300'], plat: '#00ff00', enemy: '#cc00ff' },
            { name: "ICE CAVERN", bg: ['#001a1a', '#004a4a'], plat: '#00ffff', enemy: '#ffffff' },
            { name: "VOID REALM", bg: ['#1a001a', '#2d002d'], plat: '#ff00ff', enemy: '#00ff00' }
        ];

        // --- DONN√âES & SLOTS ---
        const BASE_SAVE_KEY = 'romanf888_v15_slot_'; // Nouvelle cl√©
        let currentSlotId = 1;
        let saveState = { maxLevel: 1, coins: 0, achievements: [], cheatUsed: false };
        let gameMode = 'EASY';
        let gameTimer = 0;
        let currentBiome = BIOMES[0];

        const ACH_LIST = [
            { id: 'first_blood', name: 'Premier Pas', desc: 'Finir le niveau 1', icon: 'üö©' },
            { id: 'rich', name: 'Chercheur d\'Or', desc: 'Collecter 10 Cristaux', icon: 'üíé' },
            { id: 'dasher', name: 'L\'√âclair', desc: 'Utiliser le Dash', icon: '‚ö°' },
            { id: 'survivor', name: 'Survivant', desc: 'Atteindre le niveau 5', icon: 'üî•' },
            { id: 'hardcore', name: 'L√©gende', desc: 'Finir un niveau en Hardcore', icon: 'üíÄ' }
        ];

        // --- GESTION DES SLOTS ---
        function showSlotMenu() {
            const container = document.getElementById('slots-container');
            container.innerHTML = '';
            for(let i=1; i<=3; i++) {
                let data = null;
                try { const raw = localStorage.getItem(BASE_SAVE_KEY + i); if(raw) data = JSON.parse(raw); } catch(e){}
                const div = document.createElement('div'); div.className = 'slot-btn';
                div.innerHTML = `<div><div class="slot-title">SLOT ${i}</div><div class="slot-info">${data ? `Niv ${data.maxLevel} - ${data.coins}‚ô¶ ${data.cheatUsed ? '‚ö†Ô∏èTRICHEUR' : ''}` : 'VIDE'}</div></div><div style="font-size:24px;">‚ñ∂</div>`;
                div.onclick = () => selectSlot(i);
                container.appendChild(div);
            }
            showScreen('slot-menu');
        }

        function selectSlot(id) { currentSlotId = id; loadSave(id); showDifficulty(); }

        function loadSave(id) {
            // Reset explicite par d√©faut
            saveState = { maxLevel: 1, coins: 0, achievements: [], cheatUsed: false };
            try {
                const d = localStorage.getItem(BASE_SAVE_KEY + id);
                if(d) {
                    const loaded = JSON.parse(d);
                    // Fusion pour √©viter les bugs si champs manquants
                    saveState = {...saveState, ...loaded};
                }
            } catch(e) {}
        }

        function saveProgress(manual=false) { 
            if(gameMode !== 'EASY') { if(manual) alert("Sauvegarde impossible dans ce mode !"); return; }
            try { localStorage.setItem(BASE_SAVE_KEY + currentSlotId, JSON.stringify(saveState)); } catch(e){} 
            if(manual) alert(`Sauvegard√© sur Slot ${currentSlotId} !`);
        }

        function resetProgress() {
            if(confirm("√ätes-vous s√ªr ? Cela effacera d√©finitivement ce slot.")) { 
                // 1. Effacer du stockage
                localStorage.removeItem(BASE_SAVE_KEY + currentSlotId); 
                // 2. R√©initialiser la m√©moire locale
                saveState = { maxLevel: 1, coins: 0, achievements: [], cheatUsed: false };
                
                alert("Slot effac√© avec succ√®s !");
                // 3. Retour menu SANS recharger la page (plus fluide et s√ªr)
                exitToMenu();
                showSlotMenu(); // Force le rafra√Æchissement de la liste
            }
        }

        // --- ACHIEVEMENT LOGIC ---
        function unlockAch(id) {
            if(gameMode !== 'EASY' && id !== 'hardcore') return;
            if(!saveState.achievements.includes(id)) {
                saveState.achievements.push(id);
                const ach = ACH_LIST.find(a => a.id === id);
                if(ach) showPopup(ach.name);
                saveProgress();
            }
        }

        // --- MOTEUR ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameState = 'MENU'; 
        
        function resize() {
            canvas.width = window.innerWidth * OPTIONS.res;
            canvas.height = window.innerHeight * OPTIONS.res;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
        }
        window.addEventListener('resize', resize); resize();

        const keys = { left: false, right: false, up: false, dash: false };
        function bindTouch(id, key) {
            const btn = document.getElementById(id); if(!btn) return;
            const press = (e) => { if(gameState==='PLAY'){ e.preventDefault(); keys[key] = true; btn.classList.add('active'); if(key==='up') player.jump(); if(key==='dash') player.dash(); }};
            const release = (e) => { e.preventDefault(); keys[key] = false; btn.classList.remove('active'); };
            btn.addEventListener('touchstart', press, {passive:false}); btn.addEventListener('touchend', release);
            btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', release);
        }
        bindTouch('btn-left', 'left'); bindTouch('btn-right', 'right'); bindTouch('btn-jump', 'up'); bindTouch('btn-dash', 'dash');

        // --- ENTIT√âS ---
        class Player {
            constructor() { this.w = 30; this.h = 30; this.reset(); }
            reset() {
                this.x = 100; this.y = canvas.height - 200;
                this.vx = 0; this.vy = 0;
                this.grounded = false; this.dead = false;
                this.canDash = true; this.dashTimer = 0; this.dashCooldown = 0;
                this.invincible = false; this.invincibleTimer = 0;
            }
            jump() {
                if(!this.grounded && this.jumps < 2) { this.vy = -12; this.jumps++; }
                else if (this.grounded) { this.vy = -12; this.grounded = false; this.jumps = 1; }
            }
            dash() {
                if(this.canDash && !this.dead) {
                    this.canDash = false; this.dashTimer = 10; this.dashCooldown = 600;
                    this.vx = (this.vx > 0 ? 1 : -1) * 25; this.vy = 0;
                    unlockAch('dasher');
                }
            }
            update(dt) { 
                if(this.dead) return;
                
                if(this.invincible) {
                    if(isNaN(dt) || dt > 1.0) dt = 0;
                    this.invincibleTimer -= dt;
                    const ui = document.getElementById('invincible-timer');
                    if(ui) { ui.style.display = 'block'; ui.innerText = "INVINCIBLE: " + Math.ceil(this.invincibleTimer) + "s"; }
                    if(this.invincibleTimer <= 0) { this.invincible = false; if(ui) ui.style.display = 'none'; }
                }

                if(this.dashCooldown > 0) {
                    this.dashCooldown--; document.getElementById('dash-overlay').style.height = (this.dashCooldown/600)*100 + '%';
                } else { this.canDash = true; document.getElementById('dash-overlay').style.height = '0%'; }
                if(this.dashTimer > 0) { this.dashTimer--; this.vy = 0; }
                else {
                    if (keys.left) this.vx -= 1.5; if (keys.right) this.vx += 1.5;
                    this.vx *= 0.85; this.vy += 0.8;
                }
                this.x += this.vx; this.y += this.vy;
                if(this.y > canvas.height + 100) this.die("Chute");
            }
            die(reason) {
                if(this.dead || this.invincible) return;
                this.dead = true;
                if(gameMode === 'HARDCORE') { triggerGameOver("MORT (Hardcore)"); } 
                else { setTimeout(() => { this.reset(); cameraX = 0; }, 500); }
            }
            draw(ctx) {
                if(this.dead) return;
                if(this.invincible) {
                    ctx.fillStyle = `hsl(${Date.now() % 360}, 100%, 50%)`; ctx.shadowBlur = 20; ctx.shadowColor = ctx.fillStyle;
                } else if(OPTIONS.gfx === 'HIGH') {
                    let grad = ctx.createLinearGradient(this.x, this.y, this.x+this.w, this.y+this.h);
                    grad.addColorStop(0, '#fff'); grad.addColorStop(1, currentBiome.plat);
                    ctx.fillStyle = grad; ctx.shadowBlur = 15; ctx.shadowColor = currentBiome.plat;
                } else { ctx.fillStyle = currentBiome.plat; }
                ctx.fillRect(Math.floor(this.x), Math.floor(this.y), this.w, this.h); ctx.shadowBlur = 0;
            }
        }

        // --- GAME LOGIC ---
        const player = new Player();
        let platforms = [], crystals = [], enemies = [], flyers = [], trackers = [], goal = null, cameraX = 0;

        function generateLevel(lvl) {
            const biomeIndex = (lvl - 1) % BIOMES.length;
            currentBiome = BIOMES[biomeIndex];
            document.getElementById('ui-biome-name').innerText = currentBiome.name;
            document.getElementById('ui-biome-name').style.color = currentBiome.plat;

            if(gameMode === 'TIMED' || gameMode === 'HARDCORE') gameTimer = 60; else gameTimer = null;

            platforms = []; crystals = []; enemies = []; flyers = []; trackers = [];
            platforms.push({x: -100, y: canvas.height - 100, w: 500, h: 50});
            let x = 300;
            
            for(let i=0; i<20+(lvl*5); i++) {
                x += 100 + Math.random() * 120;
                let y = canvas.height - 100 - (Math.random() * 200);
                let w = 100 + Math.random()*100;
                platforms.push({x: x, y: y, w: w, h: 40});
                if(Math.random()>0.5) crystals.push({x: x+20, y: y-40, active: true});
                if(w > 120 && Math.random() > 0.6) enemies.push({x: x+50, y: y-30, startX: x, range: w, dir: 1, speed: 2+(lvl*0.1)});
                if(lvl >= 3 && Math.random() > 0.7) flyers.push({x: x + w/2, y: y - 100 - Math.random()*50, baseY: y - 100 - Math.random()*50, offset: Math.random() * Math.PI * 2});
                if(lvl >= 7 && Math.random() > 0.8) trackers.push({x: x, y: y - 150, speed: 1 + (lvl * 0.05)});
            }
            
            let last = platforms[platforms.length-1];
            goal = {x: last.x+last.w/2-20, y: last.y-60, w: 40, h: 60};
            player.reset();
            document.getElementById('ui-level').innerText = lvl;
        }

        function update(dt) {
            if(gameState === 'PLAY') {
                if(gameTimer !== null) {
                    gameTimer -= dt;
                    const display = document.getElementById('timer-display');
                    display.innerText = Math.ceil(gameTimer);
                    if(gameTimer <= 10) display.classList.add('danger'); else display.classList.remove('danger');
                    if(gameTimer <= 0) { triggerGameOver("TEMPS √âCOUL√â !"); return; }
                } else { document.getElementById('timer-display').innerText = ""; }

                player.update(dt); player.grounded = false;
                
                platforms.forEach(p => {
                    if(player.x < p.x+p.w && player.x+player.w > p.x && player.y < p.y+p.h && player.y+player.h > p.y) {
                        if(player.vy > 0 && player.y+player.h-player.vy <= p.y+20) {
                            player.grounded = true; player.vy = 0; player.y = p.y-player.h; player.jumps = 0;
                        }
                    }
                });

                enemies.forEach(e => {
                    e.x += e.speed * e.dir;
                    if(e.x > e.startX + e.range - 30 || e.x < e.startX) e.dir *= -1;
                    if(!player.dead && Math.abs((player.x+15)-(e.x+15))<25 && Math.abs((player.y+15)-(e.y+15))<25) player.die("Ennemi");
                });

                flyers.forEach(f => {
                    f.offset += 0.05; f.y = f.baseY + Math.sin(f.offset) * 50;
                    if(!player.dead && Math.abs((player.x+15)-(f.x))<25 && Math.abs((player.y+15)-(f.y))<25) player.die("Drone");
                });

                trackers.forEach(t => {
                    let dx = (player.x + 15) - t.x; let dy = (player.y + 15) - t.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 400) { t.x += (dx / dist) * t.speed; t.y += (dy / dist) * t.speed; }
                    if(!player.dead && dist < 25) player.die("Traqu√©");
                });

                crystals.forEach(c => {
                    if(c.active && Math.abs(player.x-c.x)<30 && Math.abs(player.y-c.y)<30) {
                        c.active = false; saveState.coins++; document.getElementById('ui-coins').innerText = saveState.coins;
                        if(saveState.coins >= 10) unlockAch('rich');
                        saveProgress();
                    }
                });

                if(goal && Math.abs(player.x-goal.x)<50 && Math.abs(player.y-goal.y)<50) {
                    gameState = 'END'; saveState.maxLevel++; unlockAch('first_blood');
                    if(gameMode === 'HARDCORE') unlockAch('hardcore');
                    if(saveState.maxLevel >= 5) unlockAch('survivor');
                    saveProgress(); showScreen('level-end-screen');
                }
                
                let targetX = player.x - canvas.width * 0.3; cameraX += (targetX - cameraX) * 0.1;
            } else if (gameState === 'MENU') { cameraX += 2; }
        }

        function draw() {
            ctx.fillStyle = '#0a0a15'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            if(OPTIONS.gfx === 'HIGH') {
                let bgGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                bgGrad.addColorStop(0, currentBiome.bg[0]); bgGrad.addColorStop(1, currentBiome.bg[1]);
                ctx.fillStyle = bgGrad; ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.save(); ctx.scale(OPTIONS.res, OPTIONS.res); ctx.translate(-Math.floor(cameraX), 0);

            ctx.strokeStyle = currentBiome.plat; ctx.lineWidth = 2;
            platforms.forEach(p => { ctx.fillStyle = '#222'; ctx.fillRect(p.x, p.y, p.w, p.h); ctx.strokeRect(p.x, p.y, p.w, p.h); });

            ctx.fillStyle = currentBiome.enemy;
            enemies.forEach(e => { ctx.beginPath(); ctx.moveTo(e.x, e.y+30); ctx.lineTo(e.x+15, e.y); ctx.lineTo(e.x+30, e.y+30); ctx.fill(); });
            flyers.forEach(f => { ctx.fillStyle = '#ffff00'; if(OPTIONS.gfx === 'HIGH') { ctx.shadowBlur=10; ctx.shadowColor='red'; } ctx.beginPath(); ctx.arc(f.x, f.y, 15, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; });
            trackers.forEach(t => { ctx.fillStyle = '#aa00ff'; ctx.shadowBlur = 15; ctx.shadowColor = '#aa00ff'; ctx.beginPath(); ctx.arc(t.x, t.y, 12, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; });
            
            ctx.fillStyle = 'gold'; crystals.forEach(c => { if(c.active) ctx.fillRect(c.x, c.y, 20, 20); });
            if(goal) { ctx.fillStyle = 'rgba(255, 255, 255, 0.3)'; ctx.fillRect(goal.x, goal.y, goal.w, goal.h); }
            if(gameState !== 'MENU') player.draw(ctx);
            ctx.restore();
            
            if(OPTIONS.fps) {
                const now = performance.now(); const fps = Math.round(1000 / (now - lastTime)); lastTime = now;
                document.getElementById('fps-counter').innerText = fps + " FPS";
                document.getElementById('fps-counter').style.display = 'block';
            } else { document.getElementById('fps-counter').style.display = 'none'; }
        }

        let lastTime = 0;
        function loop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            if(gameState !== 'PAUSE') update(dt);
            draw();
            requestAnimationFrame(loop);
        }
        
        // --- UI FUNCTIONS ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            if(id) document.getElementById(id).classList.remove('hidden');
        }
        function showDifficulty() { showScreen('difficulty-menu'); }
        function startGame(mode) {
            gameMode = mode; showScreen(null); document.getElementById('game-hud').style.display = 'block';
            gameState = 'PLAY'; 
            document.getElementById('ui-coins').innerText = saveState.coins;
            generateLevel(saveState.maxLevel);
        }
        function triggerGameOver(reason) {
            gameState = 'GAMEOVER'; document.getElementById('death-reason').innerText = reason;
            document.getElementById('game-hud').style.display = 'none'; showScreen('game-over-screen');
        }
        function retryGame() { if(gameMode === 'HARDCORE') { saveState.maxLevel = 1; saveProgress(); } startGame(gameMode); }

        function togglePause() {
            if(gameState === 'PLAY') {
                gameState = 'PAUSE';
                // RESET TABS
                document.getElementById('tab-main').innerHTML = `<h2 style="margin-top:0;">PAUSE</h2><button class="menu-btn" onclick="togglePause()">REPRENDRE</button><button class="menu-btn secondary" onclick="exitToMenu()">QUITTER</button>`;
                // UI STATE UPDATES
                if(gameMode !== 'EASY') {
                    document.getElementById('save-controls').style.display = 'none';
                    document.getElementById('save-disabled').style.display = 'block';
                } else {
                    document.getElementById('save-controls').style.display = 'block';
                    document.getElementById('save-disabled').style.display = 'none';
                }
                const cheatStatus = document.getElementById('cheat-status');
                if(saveState.cheatUsed) { cheatStatus.innerText = "‚ö†Ô∏è Code D√âJ√Ä utilis√© sur ce slot."; cheatStatus.style.color = "red"; } 
                else { cheatStatus.innerText = "Utilisation unique par sauvegarde."; cheatStatus.style.color = "#666"; }
                
                renderAchievements();
                switchTab('tab-main');
                showScreen('pause-menu');
            } else if(gameState === 'PAUSE') { gameState = 'PLAY'; showScreen(null); }
        }

        function exitToMenu() { gameState = 'MENU'; showScreen('main-menu'); document.getElementById('game-hud').style.display = 'none'; }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
        }
        function toggleOption(opt) {
            const btn = document.getElementById('opt-' + opt);
            if(opt === 'sound') { OPTIONS.sound = !OPTIONS.sound; btn.innerText = OPTIONS.sound ? "ON" : "OFF"; btn.className = `toggle-btn ${OPTIONS.sound ? 'on' : ''}`; }
            else if (opt === 'gfx') { OPTIONS.gfx = OPTIONS.gfx === 'HIGH' ? 'LOW' : 'HIGH'; btn.innerText = OPTIONS.gfx; btn.className = `toggle-btn ${OPTIONS.gfx === 'HIGH' ? 'on' : ''}`; }
            else if (opt === 'fps') { OPTIONS.fps = !OPTIONS.fps; btn.innerText = OPTIONS.fps ? "ON" : "OFF"; btn.className = `toggle-btn ${OPTIONS.fps ? 'on' : ''}`; }
            else if (opt === 'res') { OPTIONS.res = OPTIONS.res === 1.0 ? 0.5 : 1.0; btn.innerText = OPTIONS.res === 1.0 ? "100%" : "50%"; btn.className = `toggle-btn ${OPTIONS.res === 1.0 ? 'on' : ''}`; resize(); }
        }
        function checkCheat() {
            const val = document.getElementById('cheat-input').value.toUpperCase();
            if(val === "NOOB") {
                if(gameMode !== 'EASY') { alert("Triche dispo uniquement en FACILE !"); return; }
                if(saveState.cheatUsed) { alert("Code D√âJ√Ä utilis√© pour ce Slot !"); return; }
                player.invincible = true; player.invincibleTimer = 10;
                saveState.cheatUsed = true; saveProgress(); togglePause(); showPopup("TRICHE ACTIV√âE: NOOB");
            } else { alert("Code Invalide"); }
            document.getElementById('cheat-input').value = "";
        }
        function openAchievementsInMenu() {
            renderAchievements(); showScreen('pause-menu'); switchTab('tab-achievements');
            document.getElementById('btn-tab-main').style.display = 'none';
            document.getElementById('btn-tab-save').style.display = 'none';
            document.getElementById('btn-tab-settings').style.display = 'none';
            document.getElementById('btn-tab-codes').style.display = 'none';
            const backBtn = document.createElement('button'); backBtn.className = 'menu-btn secondary'; backBtn.innerText = 'RETOUR MENU'; backBtn.id = 'temp-back-btn';
            backBtn.onclick = () => {
                exitToMenu(); document.getElementById('btn-tab-main').style.display = 'block'; document.getElementById('btn-tab-save').style.display = 'block'; document.getElementById('btn-tab-settings').style.display = 'block'; document.getElementById('btn-tab-codes').style.display = 'block'; backBtn.remove();
            };
            backBtn.style.marginTop = '20px'; document.getElementById('pause-menu-content').appendChild(backBtn);
        }
        function renderAchievements() {
            const container = document.getElementById('tab-achievements'); container.innerHTML = '';
            ACH_LIST.forEach(ach => {
                const unlocked = saveState.achievements.includes(ach.id);
                container.innerHTML += `<div class="achievement ${unlocked ? 'unlocked' : ''}"><div class="ach-icon">${unlocked ? ach.icon : 'üîí'}</div><div><h4 style="margin:0; color:${unlocked?'#ffd700':'#888'}">${ach.name}</h4><p style="margin:0; font-size:12px; color:#aaa">${ach.desc}</p></div></div>`;
            });
        }
        function nextLevel() { showScreen(null); gameState = 'PLAY'; generateLevel(saveState.maxLevel); }
        function showPopup(txt) { 
            const p = document.getElementById('success-popup'); p.querySelector('span').innerText=txt;
            p.style.top='20px'; setTimeout(()=>p.style.top='-100px',3000);
        }

        // On n'appelle pas loadSave au d√©marrage
        loadSave(1); generateLevel(1); 
        requestAnimationFrame(loop);

    </script>
</body>
</html>